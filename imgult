#!/bin/sh

## jpegoptim, optipng, gifsicle and some jpegtran (preferably mozjpeg)
## must all be installed
##
## if you don't have them
## 1. shame on you!!
## mac
## 2. brew install jpegoptim mozjpeg optipng gifsicle
## linux
## 2. sbopkg -i jpegoptim -i mozjpeg -i optipng -i gifsicle
## (slackware already has jpegtran, 
## although it will check for the mozjpeg version)

BACKUPIMAGES=n
EXIFREMOVE=true

OPTLEVEL=${1:-90}

if [ "$EXIFREMOVE" = "true" ]; then
  EXTRAJTRANARGS="-copy none"
  EXTRAOPTPNARGS="-strip all"
fi

if [ -z "$JPEGTRAN" ]; then
  export PATH=/usr/local/Cellar/mozjpeg/*/bin:/opt/libmozjpeg/bin:$PATH
  JPEGTRAN="$( which jpegtran )"
  if [ -z "$JPEGTRAN" ]; then
    echo "Can't find jpegtran in $PATH, install it or set JPEGTRAN in the environment"
    exit 1
  fi
fi

find . -type f -a \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname \
  '*.gif' -o -iname '*.png' \) > imgult-files.txt

if [ "$BACKUPIMAGES" = true ]; then
  mkdir -pv imgult-backup-files/
  cp -Rv $( cat imgult-files.txt ) ../imgult-backup-files/
  mv -v imgult-backup-files/ ../imgult-backup-files/
fi

$JPEGTRAN -verbose $EXTRAJTRANARGS -outfile $( grep -i .jpg imgult-files.txt )
$JPEGTRAN -verbose $EXTRAJTRANARGS -outfile $( grep -i .jpeg imgult-files.txt )

jpegoptim -m$OPTLEVEL $( grep -i .jpg imgult-files.txt )
jpegoptim -m$OPTLEVEL $( grep -i .jpeg imgult-files.txt )

optipng $EXTRAOPTIPNARGS $( grep -i .png imgult-files.txt )

## -b keeps the filename, -O3 uses highest optimization level
## it is an 'O' as in Oxford, not a zero (0)
gifsicle -b -O3 $( grep -i .gif imgult-files.txt )

rm imgult-files.txt
