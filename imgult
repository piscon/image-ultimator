#!/bin/sh

## jpegoptim and optipng must all be installed
## if you don't have them
## 1. shame on you!!
## mac
## 2. brew install jpegoptim mozjpeg optipng gifsicle
## linux
## 2. sbopkg -i jpegoptim -i mozjpeg -i optipng -i gifsicle
## (slackware already has jpegtran, 
## although it will check for the mozjpeg version)

BACKUPIMAGES=n
EXIFREMOVE=true

#read -p "Would you like to BACKUP the original files? [y/N]: " response
#case $response in
#  [yY][eE][sS]|[yY])
#    export BACKUPIMAGES=true;
#    echo "You are backing things up, better safe than sorry!";
#    ;;
#  *)
#    echo "You are a risk taker.";
#    ;;
#esac

#read -p "Would you like to remove EXIF data? [y/N]: " response
#case $response in
#  [yY][eE][sS]|[yY])
#    export EXIFREMOVE=true;
#    echo "You are removing EXIF, keep it tidy!";
#    ;;
#  *)
#    echo "You like to know the lens used.";
#    ;;
#esac

find . -type f -a \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname \
  '*.gif' -o -iname '*.png' \) > imgult-files.txt


if [ "$BACKUPIMAGES" = true ]; then
  mkdir -pv imgult-backup-files/
  cp -Rv $( cat imgult-files.txt ) ../imgult-backup-files/
  mv -v imgult-backup-files/ ../imgult-backup-files/
fi


if [ "$EXIFREMOVE" = true ] && [ "$( uname -s )" = Darwin ] && [ -d /usr/local/Cellar/mozjpeg/ ]; then
  find . -iname "*.jpg" -type f -exec /usr/local/Cellar/mozjpeg/2.1/bin/jpegtran -verbose -copy none -outfile {} {} \;
  find . -iname "*.jpeg" -type f -exec /usr/local/Cellar/mozjpeg/2.1/bin/jpegtran -verbose -copy none -outfile {} {} \;
elif [ "$( uname -s )" = Darwin ] && [ -d /usr/local/Cellar/mozjpeg/ ]; then
  find . -iname "*.jpg" -type f -exec /usr/local/Cellar/mozjpeg/2.1/bin/jpegtran -verbose -outfile {} {} \;
  find . -iname "*.jpeg" -type f -exec /usr/local/Cellar/mozjpeg/2.1/bin/jpegtran -verbose -outfile {} {} \;
elif [ "$EXIFREMOVE" = true ] && [ -d /opt/libmozjpeg/bin/ ]; then
  find . -iname "*.jpg" -type f -exec /opt/libmozjpeg/bin/jpegtran -verbose -copy none -outfile {} {} \;
  find . -iname "*.jpeg" -type f -exec /opt/libmozjpeg/bin/jpegtran -verbose -copy none -outfile {} {} \;
elif [ -d /opt/libmozjpeg/bin/ ]; then
  find . -iname "*.jpg" -type f -exec /opt/libmozjpeg/bin/jpegtran -verbose -outfile {} {} \;
  find . -iname "*.jpeg" -type f -exec /opt/libmozjpeg/bin/jpegtran -verbose -outfile {} {} \;
elif [ "$EXIFREMOVE" = true ]; then
  find . -iname "*.jpg" -type f -exec jpegtran -verbose -copy none -outfile {} {} \;
  find . -iname "*.jpeg" -type f -exec jpegtran -verbose -copy none -outfile {} {} \;
else
  find . -iname "*.jpg" -type f -exec jpegtran -verbose -outfile {} {} \;
  find . -iname "*.jpeg" -type f -exec jpegtran -verbose -outfile {} {} \;
fi

if [ -z $1 ]; then
  find . -iname "*.jpg" -type f -exec jpegoptim -m90 {} \;
  find . -iname "*.jpeg" -type f -exec jpegoptim -m90 {} \;
else
  find . -iname "*.jpg" -type f -exec jpegoptim -m$1 {} \;
  find . -iname "*.jpeg" -type f -exec jpegoptim -m$1 {} \;
fi


if [ "$EXIFREMOVE" = true ]; then
  find . -iname "*.png" -type f -exec optipng -strip all {} \;
else
  find . -iname "*.png" -type f -exec optipng {} \;
fi

## -b keeps the filename, -O3 uses highest optimization level
## it is an 'O' as in Oxford, not a zero (0)
find . -iname "*.gif" -type f -exec gifsicle -b -O3 {} \;

