#!/bin/sh

## jpegoptim, optipng, gifsicle and some jpegtran (preferably mozjpeg)
## must all be installed
##
## if you don't have them
## 1. shame on you!!
## linux
## 2. sbopkg -i jpegoptim -i mozjpeg -i optipng -i pngquant -i gifsicle -i exiftool
## mac
## 2. brew install jpegoptim mozjpeg optipng pngquant gifsicle exiftool
## (slackware already has jpegtran, 
## although it will check for the mozjpeg version)

## prepend imgult on the command line with
## BACKUPIMAGES=true  (to back everything up)
## EXIFREMOVE=n  (to keep EXIF data)
BACKUPIMAGES=${BACKUPIMAGES:-false}
EXIFREMOVE=${EXIFREMOVE:-true}

## fancy syntax thanks to B. Watson
OPTLEVEL=${1:-90}

if [ -z "$JPEGTRAN" ]; then
  export PATH=/usr/local/Cellar/mozjpeg/*/bin:/opt/libmozjpeg/bin:$PATH
  JPEGTRAN="$( which jpegtran )"
  if [ -z "$JPEGTRAN" ]; then
    echo "Can't find jpegtran in $PATH, install it or set JPEGTRAN in the environment"
    exit 1
  fi
fi

find . -type f -a \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname \
  '*.gif' -o -iname '*.png' \) > imgult-files.txt

## back it up!
if [ "$BACKUPIMAGES" = true ]; then
  rsync -avz --files-from=imgult-files.txt $PWD ../imgult-backup-files/
fi

## clear out that exif!
## detects and uses exiftool if available
if [ "$EXIFREMOVE" = "true" ]; then
  EXTRAJTRANARGS="-copy none"
  EXTRAOPTPNARGS="-strip all"
  if [ ! -z "$( which exiftool )" ]; then
    cat imgult-files.txt | \
      while read IMGULT_FILE;
      do exiftool -overwrite_original -all= $IMGULT_FILE;
    done
  fi
fi

grep -i 'jpe\?g$' imgult-files.txt | while read IMGULT_FILE; do
  $JPEGTRAN -verbose $EXTRAJTRANARGS -outfile "$IMGULT_FILE" "$IMGULT_FILE"
  jpegoptim -m$OPTLEVEL "$IMGULT_FILE"
done

grep -i 'png$' imgult-files.txt | while read IMGULT_FILE; do
  optipng $EXTRAOPTIPNARGS "$IMGULT_FILE"
  pngquant --quality=70-99 -f -v --skip-if-larger -o "$IMGULT_FILE" -- "$IMGULT_FILE"
done

## -b keeps the filename, -O3 uses highest optimization level
## it is an 'O' as in Oxford, not a zero (0)
grep -i 'gif$' imgult-files.txt | while read IMGULT_FILE; do
  gifsicle -b -O3 "$IMGULT_FILE"
done

rm imgult-files.txt


